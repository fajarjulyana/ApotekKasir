
{% extends "base.html" %}

{% block title %}Kelola Kategori - Manajemen Apotek{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="page-title">
                <i class="fas fa-layer-group me-3"></i>Kelola Kategori
            </h1>
            <p class="page-subtitle">Manajemen kategori obat dan klasifikasi</p>
        </div>
        <div class="mt-3 mt-md-0">
            {% if current_user.is_admin() %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus me-2"></i>Tambah Kategori
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Category Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fw-bold">{{ categories|length }}</h4>
                        <p class="mb-0">Total Kategori</p>
                    </div>
                    <i class="fas fa-layer-group fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card border-0 bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-medium mb-2">Kategori Populer</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for category in categories[:5] %}
                            <span class="badge bg-light text-dark">{{ category.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <i class="fas fa-chart-pie fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2 text-primary"></i>Daftar Kategori
            </h5>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="searchInput" placeholder="Cari kategori...">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="categoriesTable">
                <thead class="table-light">
                    <tr>
                        <th class="fw-semibold">Nama Kategori</th>
                        <th class="fw-semibold">Deskripsi</th>
                        <th class="fw-semibold text-center">Jumlah Obat</th>
                        <th class="fw-semibold text-center">Tanggal Dibuat</th>
                        {% if current_user.is_admin() %}
                        <th class="fw-semibold text-center">Aksi</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-layer-group text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">{{ category.name }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="text-muted">{{ category.description or '-' }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark border fs-6">
                                {{ category.medicines|length }} obat
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="text-muted">{{ category.created_at.strftime('%d/%m/%Y') }}</span>
                        </td>
                        {% if current_user.is_admin() %}
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description or '' }}')"
                                        data-bs-toggle="tooltip" title="Edit Kategori">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }}, '{{ category.name }}', {{ category.medicines|length }})"
                                        data-bs-toggle="tooltip" title="Hapus Kategori">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Tambah Kategori Baru
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_category') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label fw-medium">Nama Kategori</label>
                        <input type="text" class="form-control" id="categoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label fw-medium">Deskripsi</label>
                        <textarea class="form-control" id="categoryDescription" name="description" rows="3" 
                                  placeholder="Deskripsi kategori (opsional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Kategori
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label fw-medium">Nama Kategori</label>
                        <input type="text" class="form-control" id="editCategoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryDescription" class="form-label fw-medium">Deskripsi</label>
                        <textarea class="form-control" id="editCategoryDescription" name="description" rows="3" 
                                  placeholder="Deskripsi kategori (opsional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Update
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    const table = $('#categoriesTable').DataTable({
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/id.json',
            search: "",
            searchPlaceholder: "Cari kategori..."
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        pageLength: 25,
        order: [[0, 'asc']]
    });

    // Custom search functionality
    $('#searchInput').on('keyup', function() {
        table.search(this.value).draw();
    });

    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
});

function editCategory(id, name, description) {
    $('#editCategoryForm').attr('action', `/categories/${id}/edit`);
    $('#editCategoryName').val(name);
    $('#editCategoryDescription').val(description);
    $('#editCategoryModal').modal('show');
}

function deleteCategory(id, name, medicineCount) {
    if (medicineCount > 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Tidak Dapat Dihapus',
            text: `Kategori "${name}" masih memiliki ${medicineCount} obat. Pindahkan obat ke kategori lain terlebih dahulu.`,
            confirmButtonColor: '#dc3545'
        });
        return;
    }

    Swal.fire({
        icon: 'question',
        title: 'Konfirmasi Hapus',
        text: `Apakah Anda yakin ingin menghapus kategori "${name}"?`,
        showCancelButton: true,
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/categories/${id}/delete`;
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
