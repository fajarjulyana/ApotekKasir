{% extends "base.html" %}

{% block title %}Penjualan - Manajemen Apotek{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-cash-register me-3"></i>Transaksi Penjualan
    </h1>
    <p class="page-subtitle">Kelola transaksi penjualan obat dengan mudah</p>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2 text-success"></i>Keranjang Belanja
                </h5>
            </div>
            <div class="card-body">
                <!-- Search Medicine -->
                <div class="mb-4 search-container">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg"
                               id="medicineSearch" placeholder="Cari obat (nama, barcode, kapasitas)..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <!-- Search Results Dropdown -->
                    <div id="searchResults" class="search-results" style="display: none;">
                        <div class="list-group">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Cart Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="cartTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-semibold">Obat</th>
                                <th class="fw-semibold">Harga</th>
                                <th class="fw-semibold text-center">Jumlah</th>
                                <th class="fw-semibold text-end">Total</th>
                                <th class="fw-semibold text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <tr id="emptyCart">
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                                    <p class="mb-0">Keranjang masih kosong</p>
                                    <small>Mulai cari obat untuk ditambahkan</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Cart Summary -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-md-6">
                        <h4 class="mb-0">
                            Total: <span id="totalAmount" class="text-success">Rp 0.00</span>
                        </h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-outline-danger me-2" onclick="clearCart()">
                            <i class="fas fa-trash me-1"></i> Kosongkan
                        </button>
                        <button type="button" class="btn btn-success" onclick="processPayment()" disabled id="checkoutBtn">
                            <i class="fas fa-credit-card me-1"></i> Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Customer Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2 text-primary"></i>Informasi Pelanggan
                </h5>
            </div>
            <div class="card-body">
                <form id="customerForm">
                    <!-- Customer Search -->
                    <div class="mb-3">
                        <label for="customerSearch" class="form-label fw-medium">Cari Pelanggan</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="customerSearch" 
                                   placeholder="Cari berdasarkan nama atau NIK..." autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" onclick="pos.searchCustomers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="customerSearchResults" class="search-results mt-1" style="display: none;">
                            <div class="list-group"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="customerName" class="form-label fw-medium">Nama Pelanggan *</label>
                        <input type="text" class="form-control" id="customerName" name="customerName"
                               placeholder="Nama lengkap pelanggan" required>
                    </div>

                    <div class="mb-3">
                        <label for="customerNik" class="form-label fw-medium">NIK Pelanggan *</label>
                        <input type="text" class="form-control" id="customerNik" name="customerNik"
                               placeholder="16 digit NIK" maxlength="16" pattern="[0-9]{16}" required>
                        <div class="form-text">NIK diperlukan untuk validasi identitas pembeli</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customerPhone" class="form-label fw-medium">Nomor Telepon</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customerPhone"
                                       placeholder="Nomor telepon">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customerWhatsapp" class="form-label fw-medium">WhatsApp</label>
                                <input type="tel" class="form-control" id="customerWhatsapp" name="customerWhatsapp"
                                       placeholder="Nomor WhatsApp">
                            </div>
                        </div>
                    </div>

                    <!-- Prescription Toggle -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isPrescription" name="isPrescription" onchange="pos.togglePrescriptionSection()">
                            <label class="form-check-label fw-medium" for="isPrescription">
                                <i class="fas fa-prescription-bottle-alt me-1"></i>
                                Transaksi Berdasarkan Resep Dokter
                            </label>
                        </div>
                    </div>

                    <!-- Doctor Information (Hidden by default) -->
                    <div id="prescriptionSection" style="display: none;">
                        <div class="border rounded p-3 mb-3 bg-light">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-user-md me-2"></i>Informasi Dokter & Resep
                            </h6>
                            
                            <!-- Doctor Search -->
                            <div class="mb-3">
                                <label for="doctorSearch" class="form-label fw-medium">Cari Dokter</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="doctorSearch" 
                                           placeholder="Cari berdasarkan nama atau nomor STR..." autocomplete="off">
                                    <button class="btn btn-outline-secondary" type="button" onclick="pos.searchDoctors()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="doctorSearchResults" class="search-results mt-1" style="display: none;">
                                    <div class="list-group"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="doctorName" class="form-label fw-medium">Nama Dokter *</label>
                                <input type="text" class="form-control" id="doctorName" name="doctorName"
                                       placeholder="Nama lengkap dokter">
                            </div>

                            <div class="mb-3">
                                <label for="prescriptionNumber" class="form-label fw-medium">Nomor Resep *</label>
                                <input type="text" class="form-control" id="prescriptionNumber" name="prescriptionNumber"
                                       placeholder="Nomor resep dokter">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorPhone" class="form-label fw-medium">Telepon Dokter</label>
                                        <input type="tel" class="form-control" id="doctorPhone" name="doctorPhone"
                                               placeholder="Nomor telepon dokter">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorWhatsapp" class="form-label fw-medium">WhatsApp Dokter</label>
                                        <input type="tel" class="form-control" id="doctorWhatsapp" name="doctorWhatsapp"
                                               placeholder="Nomor WhatsApp dokter">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label fw-medium">Metode Pembayaran</label>
                        <select class="form-select" id="paymentMethod" name="paymentMethod" onchange="pos.toggleCashPayment()">
                            <option value="cash">üíµ Tunai</option>
                            <option value="debit_card">üí≥ Kartu Debit</option>
                            <option value="credit_card">üí≥ Kartu Kredit</option>
                            <option value="digital_wallet">üì± E-Wallet</option>
                        </select>
                    </div>

                    <!-- Cash Payment Section -->
                    <div id="cashPaymentSection" class="mb-3">
                        <label for="cashAmount" class="form-label fw-medium">Jumlah Uang Cash</label>
                        <input type="number" class="form-control" id="cashAmount" name="cashAmount"
                               placeholder="0" min="0" step="0.01" onchange="pos.calculateChange()">
                        <div id="changeDisplay" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <strong>Kembalian: <span id="changeAmount">Rp 0</span></strong>
                            </div>
                        </div>
                        <div id="insufficientFunds" class="mt-2" style="display: none;">
                            <div class="alert alert-warning mb-0">
                                <strong>Uang tidak cukup!</strong>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label fw-medium">Catatan</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                  placeholder="Catatan tambahan..."></textarea>
                    </div>
                </form>
            </div>
        </div>

        <!-- Today's Sales Summary -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2 text-info"></i>Transaksi Hari Ini
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary mb-1">0</h4>
                        <small class="text-muted">Transaksi</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-1">Rp 0</h4>
                        <small class="text-muted">Penjualan</small>
                    </div>
                </div>
                <hr>
                <a href="{{ url_for('reports') }}" class="btn btn-outline-info w-100">
                    <i class="fas fa-chart-bar me-1"></i> Lihat Laporan Detail
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>Konfirmasi Pembayaran
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="receiptPreview" class="border rounded p-3 bg-light"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Batal
                </button>
                <button type="button" class="btn btn-outline-info me-2" onclick="printReceiptPDF()" id="printPdfBtn" style="display: none;">
                    <i class="fas fa-file-pdf me-1"></i> Print PDF
                </button>
                <button type="button" class="btn btn-success" onclick="confirmPayment()">
                    <i class="fas fa-check me-1"></i> Konfirmasi Pembayaran
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alternative Medicine Modal -->
<div class="modal fade" id="alternativeMedicineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Rekomendasi Obat Alternatif
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="currentMedicine" class="form-label fw-medium">Obat Saat Ini</label>
                        <input type="text" class="form-control" id="currentMedicine" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="alternativeCategory" class="form-label fw-medium">Kategori</label>
                        <input type="text" class="form-control" id="alternativeCategory" readonly>
                    </div>
                </div>
                <div id="alternativeMedicinesList" class="list-group">
                    <!-- Alternative medicines will be populated here -->
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-pills fa-3x mb-3 opacity-50"></i>
                        <p class="mb-0">Cari obat alternatif berdasarkan kategori</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Tutup
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// POS Manager class
class POSManager {
    constructor() {
        this.cart = [];
        this.total = 0;
        this.searchTimeout = null;
    }

    // Add item to cart
    addToCart(id, name, price, unit, stock) {
        const quantityInput = $('#quantityModal #quantity');
        if (!quantityInput.length) {
            // If quantity modal is not present, directly add 1 item
            this.addItemToCart(id, name, price, unit, stock, 1);
            $('#quantityModal').modal('hide');
            return;
        }

        const quantity = parseInt(quantityInput.val());
        if (isNaN(quantity) || quantity < 1 || quantity > stock) {
            showError('Jumlah Tidak Valid', `Masukkan jumlah antara 1 sampai ${stock}.`);
            return;
        }
        this.addItemToCart(id, name, price, unit, stock, quantity);
        $('#quantityModal').modal('hide');
    }

    addItemToCart(id, name, price, unit, stock, quantity) {
        const existingItemIndex = this.cart.findIndex(item => item.id === id);

        if (existingItemIndex > -1) {
            const existingItem = this.cart[existingItemIndex];
            const newQuantity = existingItem.quantity + quantity;
            if (newQuantity <= stock) {
                existingItem.quantity = newQuantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                showError('Stok Tidak Mencukupi', `Stok maksimal untuk ${name} adalah ${stock} ${unit}.`);
                return;
            }
        } else {
            if (quantity > stock) {
                showError('Stok Tidak Mencukupi', `Stok maksimal untuk ${name} adalah ${stock} ${unit}.`);
                return;
            }
            this.cart.push({
                id: id,
                name: name,
                price: price,
                unit: unit,
                quantity: quantity,
                total: price * quantity,
                stock: stock
            });
        }

        this.updateCartDisplay();
        showSuccess('Ditambahkan!', `${name} (${quantity} ${unit}) berhasil ditambahkan ke keranjang.`);
    }

    // Update cart display
    updateCartDisplay() {
        const tbody = $('#cartItems');
        tbody.empty();

        if (this.cart.length === 0) {
            tbody.append(`
                <tr id="emptyCart">
                    <td colspan="5" class="text-center py-5 text-muted">
                        <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                        <p class="mb-0">Keranjang masih kosong</p>
                        <small>Mulai cari obat untuk ditambahkan</small>
                    </td>
                </tr>
            `);
            $('#checkoutBtn').prop('disabled', true);
            this.total = 0;
        } else {
            this.cart.forEach((item, index) => {
                const row = $(`
                    <tr class="fade-in">
                        <td>
                            <div class="fw-medium">${item.name}</div>
                            <small class="text-muted">${item.unit}</small>

                        </td>
                        <td class="fw-medium">Rp ${item.price.toLocaleString('id-ID')}</td>
                        <td>
                            <div class="input-group input-group-sm justify-content-center" style="max-width: 140px;">
                                <button class="btn btn-outline-secondary" onclick="pos.updateQuantity(${index}, -1)" type="button">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="form-control text-center" value="${item.quantity}"
                                       min="1" max="${item.stock}" onchange="pos.setQuantity(${index}, this.value)">
                                <button class="btn btn-outline-secondary" onclick="pos.updateQuantity(${index}, 1)" type="button">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-end fw-bold text-success">Rp ${item.total.toLocaleString('id-ID')}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="pos.removeFromCart(${index})"
                                    data-bs-toggle="tooltip" title="Hapus dari keranjang">
                                <i class="fas fa-trash"></i>
                            </button>
                             <button type="button" class="btn btn-sm btn-outline-info" onclick="pos.showAlternativeMedicineModal(${index})"
                                    data-bs-toggle="tooltip" title="Cari Obat Alternatif">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
            $('#checkoutBtn').prop('disabled', false);
            this.total = this.cart.reduce((sum, item) => sum + item.total, 0);
        }

        $('#totalAmount').text('Rp ' + this.total.toLocaleString('id-ID'));
        
        // Recalculate change if cash payment is selected
        if ($('#paymentMethod').val() === 'cash') {
            this.calculateChange();
        }
    }

    // Update quantity by +/- buttons
    updateQuantity(index, change) {
        const item = this.cart[index];
        const newQuantity = item.quantity + change;

        if (newQuantity > 0 && newQuantity <= item.stock) {
            item.quantity = newQuantity;
            item.total = item.quantity * item.price;
            this.updateCartDisplay();
        } else if (newQuantity > item.stock) {
            showError('Stok Tidak Mencukupi', `Stok maksimal untuk ${item.name} adalah ${item.stock} ${item.unit}.`);
        }
    }

    // Set quantity from input field
    setQuantity(index, quantity) {
        const item = this.cart[index];
        const qty = parseInt(quantity);

        if (qty > 0 && qty <= item.stock) {
            item.quantity = qty;
            item.total = item.quantity * item.price;
            this.updateCartDisplay();
        } else {
            showError('Jumlah Tidak Valid', `Masukkan jumlah antara 1 sampai ${item.stock}.`);
            this.updateCartDisplay(); // Reset to previous value
        }
    }

    // Remove item from cart
    removeFromCart(index) {
        const item = this.cart[index];
        confirmAction(
            'Hapus Item',
            `Apakah Anda yakin ingin menghapus ${item.name} dari keranjang?`,
            'Ya, Hapus'
        ).then((result) => {
            if (result.isConfirmed) {
                this.cart.splice(index, 1);
                this.updateCartDisplay();
                showSuccess('Dihapus!', 'Item berhasil dihapus dari keranjang.');
            }
        });
    }

    // Clear entire cart
    clearCart() {
        if (this.cart.length > 0) {
            confirmAction(
                'Kosongkan Keranjang',
                'Apakah Anda yakin ingin mengosongkan semua item dari keranjang?',
                'Ya, Kosongkan'
            ).then((result) => {
                if (result.isConfirmed) {
                    this.cart = [];
                    this.updateCartDisplay();
                    showSuccess('Dikosongkan!', 'Keranjang berhasil dikosongkan.');
                }
            });
        }
    }

    // Toggle cash payment section visibility
    toggleCashPayment() {
        const paymentMethod = $('#paymentMethod').val();
        const cashSection = $('#cashPaymentSection');
        
        if (paymentMethod === 'cash') {
            cashSection.show();
        } else {
            cashSection.hide();
            $('#cashAmount').val('');
            $('#changeDisplay').hide();
            $('#insufficientFunds').hide();
        }
    }

    // Toggle prescription section
    togglePrescriptionSection() {
        const isPrescription = $('#isPrescription').is(':checked');
        const prescriptionSection = $('#prescriptionSection');
        
        if (isPrescription) {
            prescriptionSection.show();
            // Make prescription fields required
            $('#doctorName, #prescriptionNumber').prop('required', true);
        } else {
            prescriptionSection.hide();
            // Remove required from prescription fields
            $('#doctorName, #prescriptionNumber').prop('required', false);
            // Clear prescription form
            $('#doctorName, #prescriptionNumber, #doctorPhone, #doctorWhatsapp').val('');
        }
    }

    // Search customers
    searchCustomers() {
        const query = $('#customerSearch').val().trim();
        if (query.length < 2) {
            $('#customerSearchResults').hide();
            return;
        }

        $.ajax({
            url: '/api/search/customers',
            method: 'GET',
            data: { q: query },
            success: (customers) => {
                this.displayCustomerResults(customers);
            },
            error: (xhr, status, error) => {
                console.error('Customer search error:', error);
            }
        });
    }

    displayCustomerResults(customers) {
        const resultsContainer = $('#customerSearchResults .list-group');
        resultsContainer.empty();

        if (customers.length === 0) {
            resultsContainer.append(`
                <div class="list-group-item text-center text-muted">
                    <i class="fas fa-user-slash"></i> Tidak ada pelanggan ditemukan
                </div>
            `);
        } else {
            customers.forEach(customer => {
                resultsContainer.append(`
                    <div class="list-group-item list-group-item-action" onclick="pos.selectCustomer('${customer.name}', '${customer.nik}', '${customer.phone || ''}', '${customer.whatsapp || ''}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${customer.name}</h6>
                            <small>NIK: ${customer.nik}</small>
                        </div>
                        <p class="mb-1">${customer.phone || ''} ${customer.whatsapp ? '| WA: ' + customer.whatsapp : ''}</p>
                    </div>
                `);
            });
        }

        $('#customerSearchResults').show();
    }

    selectCustomer(name, nik, phone, whatsapp) {
        $('#customerName').val(name);
        $('#customerNik').val(nik);
        $('#customerPhone').val(phone);
        $('#customerWhatsapp').val(whatsapp);
        $('#customerSearch').val(name);
        $('#customerSearchResults').hide();
    }

    // Search doctors
    searchDoctors() {
        const query = $('#doctorSearch').val().trim();
        if (query.length < 2) {
            $('#doctorSearchResults').hide();
            return;
        }

        $.ajax({
            url: '/api/search/doctors',
            method: 'GET',
            data: { q: query },
            success: (doctors) => {
                this.displayDoctorResults(doctors);
            },
            error: (xhr, status, error) => {
                console.error('Doctor search error:', error);
            }
        });
    }

    displayDoctorResults(doctors) {
        const resultsContainer = $('#doctorSearchResults .list-group');
        resultsContainer.empty();

        if (doctors.length === 0) {
            resultsContainer.append(`
                <div class="list-group-item text-center text-muted">
                    <i class="fas fa-user-md-slash"></i> Tidak ada dokter ditemukan
                </div>
            `);
        } else {
            doctors.forEach(doctor => {
                resultsContainer.append(`
                    <div class="list-group-item list-group-item-action" onclick="pos.selectDoctor('${doctor.name}', '${doctor.str_number}', '${doctor.phone || ''}', '${doctor.whatsapp || ''}', '${doctor.specialization || ''}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${doctor.name}</h6>
                            <small>${doctor.specialization || ''}</small>
                        </div>
                        <p class="mb-1">STR: ${doctor.str_number} | ${doctor.hospital_clinic || ''}</p>
                        <small>${doctor.phone || ''} ${doctor.whatsapp ? '| WA: ' + doctor.whatsapp : ''}</small>
                    </div>
                `);
            });
        }

        $('#doctorSearchResults').show();
    }

    selectDoctor(name, strNumber, phone, whatsapp, specialization) {
        $('#doctorName').val(name);
        $('#doctorPhone').val(phone);
        $('#doctorWhatsapp').val(whatsapp);
        $('#doctorSearch').val(`${name} - ${specialization}`);
        $('#doctorSearchResults').hide();
    }

    // Calculate change for cash payment
    calculateChange() {
        const cashAmount = parseFloat($('#cashAmount').val()) || 0;
        const totalAmount = this.total;
        const changeDisplay = $('#changeDisplay');
        const insufficientFunds = $('#insufficientFunds');
        const checkoutBtn = $('#checkoutBtn');

        if (cashAmount >= totalAmount && totalAmount > 0) {
            const change = cashAmount - totalAmount;
            $('#changeAmount').text('Rp ' + change.toLocaleString('id-ID'));
            changeDisplay.show();
            insufficientFunds.hide();
            checkoutBtn.prop('disabled', false);
        } else if (cashAmount < totalAmount && totalAmount > 0) {
            changeDisplay.hide();
            insufficientFunds.show();
            checkoutBtn.prop('disabled', true);
        } else {
            changeDisplay.hide();
            insufficientFunds.hide();
            checkoutBtn.prop('disabled', this.cart.length === 0);
        }
    }

    // Validate payment before processing
    validatePayment() {
        const paymentMethod = $('#paymentMethod').val();
        
        if (paymentMethod === 'cash') {
            const cashAmount = parseFloat($('#cashAmount').val()) || 0;
            if (cashAmount < this.total) {
                showError('Pembayaran Tidak Valid', 'Jumlah uang cash tidak mencukupi untuk total pembayaran.');
                return false;
            }
        }
        return true;
    }

    // Process payment and show checkout modal
    processPayment() {
        if (this.cart.length === 0) return;

        // Validate payment first
        if (!this.validatePayment()) {
            return;
        }

        const customerName = $('#customerName').val() || 'Umum';
        const paymentMethod = $('#paymentMethod option:selected').text();
        const cashAmount = parseFloat($('#cashAmount').val()) || 0;
        const changeAmount = paymentMethod.includes('Tunai') ? (cashAmount - this.total) : 0;

        // Generate receipt preview
        let receiptHtml = `
            <div class="text-center mb-4">
                <h5 class="fw-bold">üè• Apotek Management</h5>
                <p class="text-muted mb-0">Struk Pembayaran</p>
                <small class="text-muted">${new Date().toLocaleString('id-ID')}</small>
            </div>

            <div class="row mb-3">
                <div class="col-6"><strong>Pelanggan:</strong></div>
                <div class="col-6">${customerName}</div>
            </div>
            <div class="row mb-3">
                <div class="col-6"><strong>Pembayaran:</strong></div>
                <div class="col-6">${paymentMethod}</div>
            </div>`;

        // Add cash payment details if applicable
        if (paymentMethod.includes('Tunai') && cashAmount > 0) {
            receiptHtml += `
            <div class="row mb-2">
                <div class="col-6"><strong>Jumlah Bayar:</strong></div>
                <div class="col-6">Rp ${cashAmount.toLocaleString('id-ID')}</div>
            </div>
            <div class="row mb-3">
                <div class="col-6"><strong>Kembalian:</strong></div>
                <div class="col-6">Rp ${changeAmount.toLocaleString('id-ID')}</div>
            </div>`;
        }

        receiptHtml += `

            <table class="table table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Harga</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
        `;

        this.cart.forEach(function(item) {
            receiptHtml += `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-end">Rp ${item.price.toLocaleString('id-ID')}</td>
                    <td class="text-end">Rp ${item.total.toLocaleString('id-ID')}</td>
                </tr>
            `;
        });

        receiptHtml += `
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3" class="text-end">Total Pembayaran:</th>
                        <th class="text-end text-success">Rp ${this.total.toLocaleString('id-ID')}</th>
                    </tr>
                </tfoot>
            </table>

            <div class="text-center mt-4 text-muted">
                <small>Terima kasih atas kunjungan Anda!</small>
            </div>
        `;

        $('#receiptPreview').html(receiptHtml);
        $('#checkoutModal').modal('show');
    }

    // Confirm payment and save to database
    confirmPayment() {
        const btn = document.querySelector('#checkoutModal .btn-success');
        const resetLoading = showButtonLoading(btn, 'Memproses...');

        // Validate required fields
        if (!$('#customerName').val() || !$('#customerNik').val()) {
            resetLoading();
            showError('Data Tidak Lengkap', 'Nama dan NIK pelanggan wajib diisi.');
            return;
        }

        // Validate NIK format (16 digits)
        const nik = $('#customerNik').val();
        if (!/^\d{16}$/.test(nik)) {
            resetLoading();
            showError('NIK Tidak Valid', 'NIK harus berupa 16 digit angka.');
            return;
        }

        // Validate prescription data if required
        const isPrescription = $('#isPrescription').is(':checked');
        if (isPrescription && (!$('#doctorName').val() || !$('#prescriptionNumber').val())) {
            resetLoading();
            showError('Data Resep Tidak Lengkap', 'Nama dokter dan nomor resep wajib diisi untuk transaksi resep.');
            return;
        }

        // Prepare sale data
        const cashAmount = parseFloat($('#cashAmount').val()) || null;
        const changeAmount = $('#paymentMethod').val() === 'cash' && cashAmount ? (cashAmount - this.total) : null;
        
        const saleData = {
            customer_name: $('#customerName').val(),
            customer_nik: $('#customerNik').val(),
            customer_phone: $('#customerPhone').val() || null,
            customer_whatsapp: $('#customerWhatsapp').val() || null,
            doctor_name: isPrescription ? $('#doctorName').val() : null,
            doctor_phone: isPrescription ? $('#doctorPhone').val() : null,
            doctor_whatsapp: isPrescription ? $('#doctorWhatsapp').val() : null,
            prescription_number: isPrescription ? $('#prescriptionNumber').val() : null,
            is_prescription: isPrescription,
            payment_method: $('#paymentMethod').val(),
            cash_amount: cashAmount,
            change_amount: changeAmount,
            notes: $('#notes').val() || null,
            total_amount: this.total,
            items: this.cart.map(item => ({
                medicine_id: item.id,
                quantity: item.quantity,
                unit_price: item.price,
                total_price: item.total
            }))
        };

        // Send to backend API
        $.ajax({
            url: '/api/sales/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(saleData),
            success: (response) => {
                resetLoading();
                
                if (response.success) {
                    // Show PDF print button
                    $('#printPdfBtn').show();
                    
                    // Store sale ID for PDF generation
                    window.lastSaleId = response.sale_id;
                    
                    showSuccess(
                        'Pembayaran Berhasil!',
                        `Transaksi ${response.invoice_number} telah berhasil diproses. Anda dapat mencetak struk PDF.`
                    );
                    
                    // Don't hide modal yet, let user choose to print PDF
                    btn.style.display = 'none';
                } else {
                    showError('Error', response.message || 'Gagal memproses transaksi');
                }
            },
            error: (xhr, status, error) => {
                resetLoading();
                console.error('Payment error:', error);
                showError('Error', 'Gagal memproses pembayaran. Silakan coba lagi.');
            }
        });
    }

    // Print receipt as PDF
    printReceiptPDF() {
        if (window.lastSaleId) {
            // Open PDF in new tab
            // The backend endpoint `/api/sale/<sale_id>/receipt/pdf` would generate the PDF.
            window.open(`/api/sale/${window.lastSaleId}/receipt/pdf`, '_blank');

            // Close modal and reset
            $('#checkoutModal').modal('hide');
            this.cart = [];
            this.updateCartDisplay();
            $('#customerForm')[0].reset();
            $('#printPdfBtn').hide();
            document.querySelector('#checkoutModal .btn-success').style.display = 'block';
        }
    }

    // --- Real-time Search Functionality ---

    // Search medicines with real-time functionality
    searchMedicines() {
        const query = $('#medicineSearch').val().trim();

        if (query.length < 2) {
            $('#searchResults').hide();
            return;
        }

        // Debounce search
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
            this.performSearch(query);
        }, 300);
    }

    performSearch(query) {
        $.ajax({
            url: '/api/search/medicines',
            method: 'GET',
            data: { q: query },
            success: (medicines) => {
                this.displaySearchResults(medicines);
            },
            error: (xhr, status, error) => {
                console.error('Search error:', error);
                showError('Error', 'Gagal mencari obat');
            }
        });
    }

    displaySearchResults(medicines) {
        const resultsContainer = $('#searchResults .list-group');
        resultsContainer.empty();

        if (medicines.length === 0) {
            resultsContainer.append(`
                <div class="list-group-item text-center text-muted">
                    <i class="fas fa-search"></i> Tidak ada obat ditemukan
                </div>
            `);
        } else {
            medicines.forEach(medicine => {
                const stockBadge = medicine.stock <= 10 ?
                    `<span class="badge bg-warning">Stok Rendah: ${medicine.stock}</span>` :
                    `<span class="badge bg-success">${medicine.stock} ${medicine.unit}</span>`;

                // Image display logic
                // The image_url should point to the correct static path (e.g., /static/uploads/medicines/<filename>)
                // The onerror handler is added to ensure a fallback image is shown if the URL is broken.
                const imageHtml = medicine.image_url ?
                    `<img src="${medicine.image_url}" alt="${medicine.name}" class="medicine-image me-3"
                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
                         onerror="this.src='/static/images/no-image.png'">` :
                    `<div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="fas fa-pills text-primary"></i>
                    </div>`;

                const locationHtml = medicine.storage_location ?
                    `<small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${medicine.storage_location}</small>` : '';

                resultsContainer.append(`
                    <div class="list-group-item" onclick="pos.selectMedicine(${medicine.id}, '${medicine.name}', ${medicine.price}, '${medicine.unit}', ${medicine.stock})">
                        <div class="d-flex align-items-center">
                            ${imageHtml}
                            <div class="flex-grow-1">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${medicine.name}</h6>
                                    ${stockBadge}
                                </div>
                                <p class="mb-1">${medicine.capacity || ''} | Rp ${medicine.price.toLocaleString()}</p>
                                ${locationHtml}
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        $('#searchResults').show();
    }

    selectMedicine(id, name, price, unit, stock) {
        if (stock <= 0) {
            showError('Stok Habis', 'Obat ini sudah habis stoknya');
            return;
        }

        $('#medicineSearch').val(name);
        $('#searchResults').hide();

        // Add to cart or show quantity dialog
        this.showQuantityDialog(id, name, price, unit, stock);
    }

    showQuantityDialog(id, name, price, unit, stock) {
        const modalHtml = `
            <div class="modal fade" id="quantityModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Tambah ke Keranjang</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h6>${name}</h6>
                            <p>Harga: Rp ${price.toLocaleString()} per ${unit}</p>
                            <p>Stok tersedia: ${stock} ${unit}</p>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Jumlah</label>
                                <input type="number" class="form-control" id="quantity" min="1" max="${stock}" value="1">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="button" class="btn btn-primary" onclick="pos.addToCart(${id}, '${name}', ${price}, '${unit}', ${stock})">
                                Tambah ke Keranjang
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        $('body').append(modalHtml);
        $('#quantityModal').modal('show');

        $('#quantityModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }

    // --- Alternative Medicine Functionality ---
    showAlternativeMedicineModal(cartIndex) {
        const item = this.cart[cartIndex];
        $('#currentMedicine').val(`${item.name} (${item.quantity} ${item.unit})`);
        $('#alternativeCategory').val('N/A'); // Placeholder, will be fetched or set

        // Fetch alternative medicines
        this.fetchAlternativeMedicines(item.id, item.category_id || null); // Assuming category_id is available
        $('#alternativeMedicineModal').modal('show');
    }

    fetchAlternativeMedicines(currentMedicineId, categoryId) {
        const alternativeMedicinesList = $('#alternativeMedicinesList');
        alternativeMedicinesList.empty();
        alternativeMedicinesList.append('<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Mencari alternatif...</div>');

        // In a real application, you'd make an API call here.
        // Example: $.get(`/api/medicines/${currentMedicineId}/alternatives?category=${categoryId || ''}`, (data) => { ... });

        // For demonstration, let's mock some data
        setTimeout(() => {
            const alternatives = [
                { id: 101, name: 'Paramex Flu & Batuk', price: 5000, unit: 'tablet', stock: 50, category: 'Obat Batuk & Flu' },
                { id: 102, name: 'Bodrex Flu & Batuk', price: 4500, unit: 'tablet', stock: 45, category: 'Obat Batuk & Flu' },
                { id: 103, name: 'Komix Batuk & Flu', price: 7000, unit: 'sachet', stock: 30, category: 'Obat Batuk & Flu' }
            ];

            if (alternatives.length > 0) {
                alternativeMedicinesList.empty();
                alternatives.forEach(alt => {
                    const stockBadge = alt.stock > 0 ?
                        `<span class="badge bg-success">${alt.stock} ${alt.unit}</span>` :
                        `<span class="badge bg-danger">Habis</span>`;

                    alternativeMedicinesList.append(`
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${alt.name}</h6>
                                <small class="text-muted">${alt.category || 'Tidak Diketahui'}</small><br>
                                <small class="fw-bold">Rp ${alt.price.toLocaleString('id-ID')}</small>
                            </div>
                            <div>
                                ${stockBadge}
                                <button class="btn btn-sm btn-outline-success ms-2" onclick="pos.addAlternativeToCart(${alt.id}, '${alt.name}', ${alt.price}, '${alt.unit}', ${alt.stock})" ${alt.stock <= 0 ? 'disabled' : ''}>
                                    <i class="fas fa-plus"></i> Tambah
                                </button>
                            </div>
                        </div>
                    `);
                });
            } else {
                alternativeMedicinesList.html('<div class="text-center py-3 text-muted">Tidak ada alternatif ditemukan untuk obat ini.</div>');
            }
        }, 1000); // Simulate network delay
    }

    addAlternativeToCart(id, name, price, unit, stock) {
        // Directly add to cart without quantity dialog for alternatives
        this.addItemToCart(id, name, price, unit, stock, 1);
        showSuccess('Ditambahkan!', `${name} berhasil ditambahkan ke keranjang.`);
        $('#alternativeMedicineModal').modal('hide'); // Hide modal after adding
    }
}

// Helper function to show error messages
function showError(title, message) {
    Swal.fire({
        icon: 'error',
        title: title,
        text: message,
        confirmButtonColor: '#dc3545'
    });
}

// Helper function to show success messages
function showSuccess(title, message) {
    Swal.fire({
        icon: 'success',
        title: title,
        text: message,
        confirmButtonColor: '#28a745'
    });
}

// Helper function to confirm actions
function confirmAction(title, message, confirmButtonText) {
    return Swal.fire({
        icon: 'question',
        title: title,
        text: message,
        showCancelButton: true,
        confirmButtonText: confirmButtonText,
        cancelButtonText: 'Batal',
        confirmButtonColor: '#0d6efd',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
    });
}

// Helper function to show button loading state
function showButtonLoading(button, text) {
    const originalText = button.innerHTML;
    button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${text}`;
    button.disabled = true;
    return () => {
        button.innerHTML = originalText;
        button.disabled = false;
    };
}


// Initialize POS
$(document).ready(function() {
    window.pos = new POSManager();

    // Initialize cash payment section visibility
    pos.toggleCashPayment();

    // Search functionality with real-time search
    $('#searchBtn').click(() => pos.searchMedicines());

    // Real-time search on typing
    $('#medicineSearch').on('input', function() {
        pos.searchMedicines();
    });

    // Customer search on typing
    $('#customerSearch').on('input', function() {
        pos.searchCustomers();
    });

    // Doctor search on typing
    $('#doctorSearch').on('input', function() {
        pos.searchDoctors();
    });

    // Handle Enter key
    $('#medicineSearch').keypress(function(e) {
        if (e.which === 13) {  // Enter key
            e.preventDefault();
            const firstResult = $('#searchResults .list-group-item:first');
            if (firstResult.length) {
                firstResult.click();
            }
        }
    });

    // Hide search results when clicking outside
    $(document).click(function(e) {
        if (!$(e.target).closest('.search-container').length) {
            $('#searchResults').hide();
        }
        if (!$(e.target).closest('#customerSearch, #customerSearchResults').length) {
            $('#customerSearchResults').hide();
        }
        if (!$(e.target).closest('#doctorSearch, #doctorSearchResults').length) {
            $('#doctorSearchResults').hide();
        }
    });
});

// Global functions accessible by inline onclick (if needed, though better to use POSManager methods)
function addToCart(id, name, price, unit, stock) {
    window.pos.addToCart(id, name, price, unit, stock);
}

function updateQuantity(index, change) {
    window.pos.updateQuantity(index, change);
}

function setQuantity(index, quantity) {
    window.pos.setQuantity(index, quantity);
}

function removeFromCart(index) {
    window.pos.removeFromCart(index);
}

function clearCart() {
    window.pos.clearCart();
}

function processPayment() {
    window.pos.processPayment();
}

function confirmPayment() {
    window.pos.confirmPayment();
}

function printReceiptPDF() {
    window.pos.printReceiptPDF();
}

function showAlternatives() {
    // This function is a placeholder and should be adapted based on how you want to trigger the alternative search.
    // For example, it could open a modal to search for alternatives based on current cart item.
    console.log("Show alternatives button clicked");
    // Example: if you want to show it for the first item in cart:
    if (window.pos.cart.length > 0) {
        window.pos.showAlternativeMedicineModal(0); // Show for the first item
    } else {
        showError("Keranjang Kosong", "Tambahkan obat ke keranjang terlebih dahulu untuk mencari alternatif.");
    }
}

</script>
{% endblock %}