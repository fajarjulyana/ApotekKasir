{% extends "base.html" %}

{% block title %}Laporan - Manajemen Apotek{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar"></i> Laporan</h2>
        <hr>
    </div>
</div>

<!-- Report Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filter Laporan</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="reportType" class="form-label">Jenis Laporan</label>
                        <select class="form-select" id="reportType">
                            <option value="sales">Penjualan</option>
                            <option value="inventory">Inventory</option>
                            <option value="expiry">Kadaluwarsa</option>
                            <option value="top_selling">Obat Terlaris</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Tanggal Mulai</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">Tanggal Akhir</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-chart-line"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Selling Medicines -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> Obat Terlaris (30 Hari)</h5>
            </div>
            <div class="card-body">
                {% if top_selling %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Ranking</th>
                                <th>Nama Obat</th>
                                <th>Terjual</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in top_selling %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ loop.index }}</span>
                                </td>
                                <td>{{ item.name }}</td>
                                <td>{{ item.total_sold }}</td>
                                <td>Rp {{ "%.2f"|format(item.total_revenue) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Belum ada data penjualan dalam 30 hari terakhir.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Grafik Penjualan</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Sales Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Ringkasan Penjualan Bulan Ini</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ monthly_sales|length }}</h3>
                            <p class="mb-0">Total Transaksi</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success">
                                Rp {{ "%.2f"|format(monthly_sales|sum(attribute='total_amount') if monthly_sales else 0) }}
                            </h3>
                            <p class="mb-0">Total Revenue</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">
                                Rp {{ "%.2f"|format((monthly_sales|sum(attribute='total_amount') / monthly_sales|length) if monthly_sales else 0) }}
                            </h3>
                            <p class="mb-0">Rata-rata per Transaksi</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <a href="{{ url_for('export_inventory') }}" class="btn btn-success">
                                <i class="fas fa-download"></i> Export Excel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Transaksi Terbaru</h5>
            </div>
            <div class="card-body">
                {% if monthly_sales %}
                <div class="table-responsive">
                    <table class="table table-striped" id="recentSalesTable">
                        <thead>
                            <tr>
                                <th>No. Invoice</th>
                                <th>Tanggal</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Metode Bayar</th>
                                <th>Kasir</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in monthly_sales[-10:] %}
                            <tr>
                                <td>{{ sale.invoice_number }}</td>
                                <td>{{ sale.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ sale.customer_name or 'Umum' }}</td>
                                <td>Rp {{ "%.2f"|format(sale.total_amount) }}</td>
                                <td>{{ sale.payment_method|title }}</td>
                                <td>{{ sale.cashier.full_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Belum ada transaksi bulan ini.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Alternative Recommendations -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> Rekomendasi Alternatif</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Fitur rekomendasi obat alternatif berdasarkan kategori dan kapasitas akan ditampilkan di sini.
                    Sistem akan memberikan saran obat pengganti ketika stok obat tertentu habis.
                </p>
                <button type="button" class="btn btn-outline-primary" onclick="showAlternatives()">
                    <i class="fas fa-search"></i> Cari Alternatif Obat
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Set default dates
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    $('#startDate').val(firstDay.toISOString().split('T')[0]);
    $('#endDate').val(today.toISOString().split('T')[0]);
    
    // Initialize DataTable
    $('#recentSalesTable').DataTable({
        responsive: true,
        order: [[1, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/id.json'
        }
    });
    
    // Initialize Chart
    initializeSalesChart();
});

function initializeSalesChart() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    // Sample data - replace with actual data
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for item in top_selling[:5] %}
                '{{ item.name }}'{{ ',' if not loop.last }}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for item in top_selling[:5] %}
                    {{ item.total_sold }}{{ ',' if not loop.last }}
                    {% endfor %}
                ],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function generateReport() {
    const reportType = $('#reportType').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    if (!startDate || !endDate) {
        alert('Pilih rentang tanggal terlebih dahulu');
        return;
    }
    
    // TODO: Implement report generation
    alert(`Generating ${reportType} report from ${startDate} to ${endDate}`);
}

function showAlternatives() {
    // TODO: Implement alternative medicine recommendations
    alert('Fitur rekomendasi alternatif akan segera diimplementasi');
}
</script>
{% endblock %}